# Implementation Plan: Credential Persistence & Account Recovery

**Branch**: `010-credential-persistence` | **Date**: 2026-01-29` | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/010-credential-persistence/spec.md`

## Summary

Add persistent credential storage and account recovery to the Hackathon Todo Evolution application. Currently using stateless JWT cookies that expire when browser closes, preventing users from signing in again. This feature adds PostgreSQL-backed credential storage via Better Auth database adapter, email-based password reset, and email verification for account recovery.

**Key Changes**:
- Migrate from stateless cookies to PostgreSQL-backed sessions
- Add email service integration (Resend) for verification and password reset
- Implement rate limiting for password reset requests
- Create password reset and email verification UI flows

## Technical Context

**Language/Version**: TypeScript 5+, Python 3.13+
**Primary Dependencies**: Better Auth (database adapter), PostgreSQL (pg), Resend (email)
**Storage**: PostgreSQL (Neon Serverless)
**Testing**: pytest (Python), Vitest/Playwright (frontend)
**Target Platform**: Web (Next.js 15+ frontend, FastAPI backend)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: Sign-in within 5 seconds, email delivery within 2 minutes (95%)
**Constraints**: Must use Better Auth with PostgreSQL (constitution mandate), rate limit to 3 requests/hour
**Scale/Scope**: Support unlimited users, session tokens expire after 7 days

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-checked after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Spec-Driven Development | ✅ PASS | Spec created and approved before plan |
| II. Skills & Subagents First | ✅ PASS | Better Auth docs referenced via Context7 |
| III. Context7 Knowledge Acquisition | ✅ PASS | Queried Better Auth database adapter patterns |
| IV. No Manual Coding | ✅ PASS | Implementation via `/sp.implement` |
| V. Phase Governance | ✅ PASS | Phase II (Full-Stack Web App) - appropriate scope |
| VI. Technology Constraints | ✅ PASS | Uses Better Auth + PostgreSQL (mandated stack) |
| VII. Agent Behavior Rules | ✅ PASS | No code generated without task reference |
| VIII. Quality & Architecture | ✅ PASS | Clean architecture maintained |
| IX. Cloud-Native Readiness | ✅ PASS | Neon PostgreSQL serverless, container-ready |

**Result**: All gates passed. Proceed to implementation.

## Project Structure

### Documentation (this feature)

```text
specs/010-credential-persistence/
├── plan.md              # This file
├── research.md          # Phase 0: Database adapter & email service research
├── data-model.md        # Phase 1: Entity relationships and schema
├── quickstart.md        # Phase 1: Setup and usage guide
├── contracts/           # Phase 1: API contracts
│   └── credential-api.yaml
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2: Generated by /sp.tasks (NOT created yet)
```

### Source Code (repository root)

```text
frontend/
├── lib/
│   ├── auth.ts              # MODIFY: Add database adapter, email callbacks
│   ├── auth-client.ts       # EXISTING: Client-side auth client
│   └── email.ts             # NEW: Email service with Resend + rate limiting
├── app/
│   ├── (auth)/
│   │   ├── sign-in/page.tsx      # MODIFY: Enable "Forgot Password" link
│   │   ├── sign-up/page.tsx      # MODIFY: Add verification status indicator
│   │   ├── forgot-password/page.tsx   # NEW: Password request form
│   │   └── reset-password/
│   │       └── [token]/page.tsx  # NEW: Password reset form
│   └── api/auth/              # Better Auth API routes (auto-generated)

backend/
├── app/
│   ├── models.py             # EXISTING: User reference model for foreign keys
│   ├── auth.py               # EXISTING: JWT verification for API routes
│   └── database.py           # EXISTING: Database session management
```

**Structure Decision**: Web application structure selected. Frontend uses Next.js with App Router, backend uses FastAPI. Authentication managed by Better Auth in frontend, validated via JWT in backend. PostgreSQL database serves as single source of truth for user credentials.

## Architecture Overview

```
┌────────────────────────────────────────────────────────────────────┐
│                           Frontend (Next.js)                        │
│  ┌─────────────┐         ┌──────────────┐         ┌─────────────┐ │
│  │ Sign In/Up  │────────▶│ Better Auth  │────────▶│   Resend    │ │
│  │   Pages     │         │  (Database)   │         │ Email API   │ │
│  └─────────────┘         └──────┬───────┘         └─────────────┘ │
│                                  │                                  │
│                                  ▼                                  │
│                          ┌───────────────┐                          │
│                          │ JWT Cookies   │                          │
│                          └───────────────┘                          │
└────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ JWT Authorization
                                   ▼
┌────────────────────────────────────────────────────────────────────┐
│                           Backend (FastAPI)                         │
│  ┌─────────────┐         ┌──────────────┐         ┌─────────────┐ │
│  │   Tasks     │◄────────│   Current    │◄────────│ Better Auth │ │
│  │   API       │         │    User      │         │   JWKS      │ │
│  └─────────────┘         └──────────────┘         └─────────────┘ │
│                                  │                                  │
│                                  ▼                                  │
│                          ┌───────────────┐                          │
│                          │   Neon        │                          │
│                          │ PostgreSQL    │                          │
│                          └───────────────┘                          │
└────────────────────────────────────────────────────────────────────┘
```

## Implementation Phases

### Phase 1A: Database Integration (P1 - Persistent Sign-In)

**Goal**: Enable persistent credential storage so users can sign in from any device.

| Task | Description |
|------|-------------|
| Install dependencies | `npm install pg @types/pg @better-auth/cli resend` |
| Configure database | Add `DATABASE_URL` environment variable |
| Run migrations | `npx @better-auth/cli migrate` |
| Update auth config | Add PostgreSQL adapter to Better Auth |
| Remove stateless config | Delete `cookieCache` and `storeStateStrategy` |
| Test sign-in flow | Verify sign-in works after browser close |

### Phase 1B: Password Reset (P2 - Password Recovery)

**Goal**: Enable users to recover accounts via email reset link.

| Task | Description |
|------|-------------|
| Add email service | Create `lib/email.ts` with Resend client |
| Configure reset callback | Add `sendResetPassword` to Better Auth |
| Create forgot-password page | `/forgot-password` route with email form |
| Create reset-password page | `/reset-password/[token]` route with new password form |
| Update sign-in page | Enable "Forgot Password" button link |
| Add rate limiting | 3 requests per hour per email |
| Test reset flow | End-to-end verification of password reset |

### Phase 1C: Email Verification (P3 - Email Verification)

**Goal**: Verify email ownership to enable reliable password recovery.

| Task | Description |
|------|-------------|
| Configure verification callback | Add `sendVerificationEmail` to Better Auth |
| Enable requirement | Set `requireEmailVerification: true` |
| Add verification indicator | Show email status in user profile |
| Test verification flow | End-to-end verification of email link |

## Dependencies

### External Services

| Service | Purpose | Account Required |
|---------|---------|-------------------|
| Neon PostgreSQL | User credential storage | Yes (existing) |
| Resend | Email delivery (verification/reset) | Yes (new) |

### NPM Packages

| Package | Version | Purpose |
|---------|---------|---------|
| pg | ^8.x | PostgreSQL client for Better Auth |
| @types/pg | ^8.x | TypeScript types |
| @better-auth/cli | latest | Database migration tool |
| resend | ^3.x | Email service SDK |

## Security Considerations

1. **Email Enumeration**: Password reset returns same message regardless of whether email exists (FR-009)
2. **Token Expiration**: All tokens expire after 1 hour
3. **Rate Limiting**: 3 password reset requests per hour per email address
4. **Secure Cookies**: HTTPS-only cookies in production
5. **Password Hashing**: Bcrypt via Better Auth (not stored in backend User model)

## Migration Strategy

### Data Migration

1. **Existing Users**: Current `user` table will be extended with Better Auth columns
2. **No Data Loss**: Foreign key relationships preserved via matching `id` field
3. **Backward Compatibility**: JWT verification in backend remains unchanged

### Rollback Plan

If issues arise:
1. Revert `frontend/lib/auth.ts` to stateless configuration
2. Users can continue using existing sessions until expiration
3. New sign-ups temporarily disabled

## Success Criteria Validation

| Criteria | Verification Method |
|----------|---------------------|
| Sign-in within 5 seconds | Manual testing with stopwatch |
| Email delivery 2 minutes (95%) | Monitor Resend dashboard analytics |
| 100% account persistence | Close/reopen browser test |
| Reset links work 99% | Track verification token success rate |
| Zero permanent account loss | Test cookie clearance scenarios |

## Open Questions

None resolved. All technical decisions documented in research.md.

## Next Steps

1. Review and approve this plan
2. Run `/sp.tasks` to generate implementation tasks
3. Run `/sp.implement` to execute the tasks
